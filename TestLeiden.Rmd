---
title: "Leiden Example"
author: "Brandt Bessell"
date: "2023-12-08"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(Rcpp)
library(igraph)
library(Matrix)
source("r/graphFromFitHIC.R")  
source("r/plotLeiden.R")
source("r/plot_graph.R")
update.packages("Rcpp")
setwd("C:/Users/bbessell/Projects/GitHub/AluNet")
Sys.setenv(PKG_CXXFLAGS = "-std=c++17")
Sys.which("make") 
Sys.which("g++")
#sourceCpp("rcpp/compile_test.cpp", verbose = TRUE, rebuild = TRUE)
#sourceCpp("rcpp/GraphUtils.cpp", verbose = F, rebuild = TRUE)
sourceCpp("rcpp/Leiden.cpp", verbose = F, rebuild = TRUE)
#set.seed(1)
```

```{r}
g <- as_edgelist(make_graph('noperfectmatching'))
#g <- as_edgelist(make_graph('Zachary'))
g_list <- list(
  to=g[,1],
  from=g[,2],
  weight=rep(1, length(g[,1]))
  
)

# before clustering
#plot.graph(g_list, "karate_nodes.png", small_nodes=F)
# after clustering
iterations <- 2
gamma <- .1  # gamma > 0
theta <- 0.01 # good theta is 0.005 < 0.05
result <- runLeiden(g_list, iterations, gamma, theta)
#plot.graph(result, "karate_leiden.png")

```

```{r}
plotLeiden(result)
```


```{r}
#gdf <- make_graph("noperfectmatching")
gdf <- make_graph("Zachary")

gamma <- .1
iterations <- 1

ldc <- cluster_leiden(
  gdf,
  resolution_parameter=gamma,
  objective_function="CPM",
  weights=g_list[["weight"]],
  beta=theta,
  n_iterations=iterations,
  vertex_weights = rep(1, length(unique(c(g_list[["to"]], g_list[["from"]]))))
)

#ldc <- cluster_louvain(gdf, weights = NULL, resolution = 1)

color_palette <- heat.colors(100)

plot(
  gdf,
  layout = layout_with_fr(gdf),
  vertex.color = ldc$membership,  # Color nodes based on community
  edge.color = color_palette[g_list$weight],  # Map edge color from cold to hot
  vertex.label = V(gdf)$community,
  edge.arrow.size = 0,  # Set arrow size to 0 to remove arrows
  main = "Graph with Community Colors and Edge Weights"
)

# Add a legend for community colors
legend("topright", legend = unique(ldc$membership),
       col = ldc$membership, pch = 19,
       title = "Communities", cex = 0.8)
```
