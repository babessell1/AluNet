---
title: "R Notebook"
output: html_notebook
---
 

```{r}
library(Rcpp)
library(igraph)
library(Matrix)
source("r/graphFromFitHIC.R")  
update.packages("Rcpp")
setwd("C:/Users/bbessell/Projects/GitHub/AluNet")
Sys.setenv(PKG_CXXFLAGS = "-std=c++17")
Sys.which("make")
Sys.which("g++")
#sourceCpp("rcpp/compile_test.cpp", verbose = TRUE, rebuild = TRUE)
#sourceCpp("rcpp/GraphUtils.cpp", verbose = F, rebuild = TRUE)
```

```{r}
sourceCpp("rcpp/Leiden.cpp", verbose = F, rebuild = TRUE)
```

```{r}
#g_list <- graphFromFitHIC("data/hic_test.txt", "chr1")
g_list <- graphFromFitHIC("data/hic_test_10k.txt", "chr1")
#g_list <- graphFromFitHIC("data/GSE148434_NS_all.5kb.1e-2.FitHiC.all.txt", "chr1")
#g_list <- list(
#  to =   c("1", "3", "5", "7", "7", "11", "11"),
#  from = c("0", "2", "4", "12", "8", "8", "12"),
#  weight = c(1, 1, 1, 1, 1, 1, 1)
#)
graph_data <- createGraphFromList(g_list)
edges <- g_list$edges
weights <- g_list$weights
#print(graph_data)
g <- graph.data.frame(graph_data)
#print(g)
edge_weights <- E(g)$w
V(g)$label <- NA
E(g)$label <- NA
layout <- layout_with_fr(g, dim=2)

# Increase the size of the plot
par(mar = c(1, 1, 1, 1))  # Adjust margins if needed
layout <- layout_with_fr(g, dim = 2)

# Set the size of the plot device using the 'width' and 'height' parameters
png("test_graph.png", width = 2000, height = 2000)  # Adjust width and height as needed

# Plot the graph with smaller nodes
plot.igraph(g, layout = layout, vertex.size = .01, vertex.label.dist = 2, edge.alpha = 1, edge.arrow.size = 0)

dev.off()  # Close the plot device
plot.igraph(g, layout = layout, vertex.size = .01, vertex.label.dist = 2, edge.alpha = 1, edge.arrow.size = 0)
```

```{r}
g_list <- graphFromFitHIC("data/hic_test_10k.txt", "chr1")
print(length(unique(c(g_list[["to"]], g_list[["from"]]))))
output <- runLeiden(g_list, 2)
print(output[["communities"]])
print(output[["nodes"]])
print(output[["node_names"]])
# 4258
```

```{r}
print(output$communities[1])
print(output$communities[length(output$communities)])
print(output$nodes[1])
print(output$nodes[length(output$nodes)])
```

```{r}
iterations <- 10

numNodes <- 5

# Define the weights for the edges
weights <- rep(1, numNodes)
weights <- weights / sum(weights)
# Define edges such that each node has exactly two edges
# For example, a simple ring where each node is connected to its next and previous node
edges <- matrix(c(
  1, 2,
  2, 3,
  3, 4,
  4, 5,
  5, 1, # Connecting the last node back to the first
  1, 5, # Adding second set of connections to make two edges per node
  2, 1,
  3, 2,
  4, 3,
  5, 4
), ncol = 2, byrow = TRUE)

# Create the graph list with 'from', 'to', and 'weight' components
graphList <- list(
  from = as.character(edges[, 1]),
  to = as.character(edges[, 2]),
  weight = weights
)

# Now you can call runLeiden (make sure it's properly defined in your C++ code and exposed to R)
result <- runLeiden(graphList, iterations)
```


```{r}
# new test file
numClusters <- 3  # Number of clusters
nodesPerCluster <- 4  # Nodes in each cluster
numSingletons <- 2  # Number of singletons

# Initialize variables
edges <- matrix(ncol = 2, nrow = 0)
weights <- c()

# Helper function to add a cluster
add_cluster <- function(node_start) {
  # Create a ring within the cluster
  cluster_edges <- cbind(
    (node_start:(node_start + nodesPerCluster - 1)),
    c((node_start + 1):(node_start + nodesPerCluster - 1), node_start)
  )
  cluster_weights <- rep(1, nrow(cluster_edges))
  list(edges = cluster_edges, weights = cluster_weights)
}

# Add clusters
node_count <- 0
for (i in 1:numClusters) {
  cluster <- add_cluster(node_count)
  edges <- rbind(edges, cluster$edges)
  weights <- c(weights, cluster$weights)
  node_count <- node_count + nodesPerCluster
}

# Adjust for 1-based indexing
edges <- edges + 1

# Add weights
weights <- weights / sum(weights)  # Normalize weights

# Create the graph list
graphList <- list(
  from = as.character(edges[, 1]),
  to = as.character(edges[, 2]),
  weight = weights
)

# Print graph information
print(graphList)
result <- runLeiden(graphList, iterations)
```
